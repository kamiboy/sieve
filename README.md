All the files assume a certain folder structure which will need to be updated if used in any other settings.

These following were scripts used to obtain TSS and TTS features from PlantCaduceus and a2z, upon which the models were trained. The DNA sequences and TPM data are sourced from the PlantCaduceus training data.
Unlike PlantCaduceus we only used about a 5000bp TSS/TTS sequence length.

prepare.sequences.py: This script reads PlantCaduceus training data file "data.csv", and outputs sequences to be used for PlantCaduceus and a2z feature extraction.

sequence2embedding.caduceus.py: This script extracts features from PlantCaduceus for the sequences. It requires a CUDA capable machine.

sequence2embedding.a2z.py: This script extracts features from a2z for the sequences. It runs on CPU.

The following scripts were used for RNAseq processing.

RNAseq.pipeline.sh: This shell script is used to process raw RNAseq reads
RNAseq.R: This shell script is used to calculate TPMs for each gene in each sample using the output from "RNAseq.pipeline.sh"
RNAseq.QC.py: This script parses QC from the output of "RNAseq.pipeline.sh", to determine which lines fail the minimum 70% aligned reads. 

The following scripts were used for PhytoExpr processing.

PhytoExpr.scores.R: This script is used to process predictions in the file bdi.newexppred.sequences.csv and outputs scores.tsv, which contains the scores for each variant, calculated as the score of the alt variant subtracted by the score of the ref variant. Additionally the file scores.ref.alt.tsv is output which contains the ref and alt variant scores by themselves.

The following script was used for generating REF and ALT a2z scores for BD21.3 variants.

a2z.ocr.py: Uses provided model (model-accessibility-full.h5) to generate a2z scores for REF and ALT alleles of all variants in provided .bim file (snps.combined.bim). Sequences are obtained from provided fasta file (BdistachyonBd21_3_537_v1.0.fa) to obtain sequences. It uses functions from a2z source, which is expected to be located in the folder (a2z). A zip containing the files is present in this github (a2z.zip) .

The following scripts were used for generating caduceus and a2z embeddings for BD21.3 variants.

FASTA.py, bedbug.py, mRNA.py: Tools needed by make.bd.data.py

make.bd.data.py: This script generates unique TTS and TSS sequences containing variants for each gene, for each plant. It needs a fasta file defining sequences (BdistachyonBd21_3_537_v1.0.fa), gff defining genes (annotation/BdistachyonBd21_3_537_v1.2.gene.gff3), bed/bim/fam files defining all variants (snps.combined.*), a file (gene.id.translation.tsv) providing gene id translations between BD21 and BD21.3. The script generates sequences in the file (data.bd.csv) which generally imitates the format of the file (data.csv) which contains the published Phytoexpr training data, and stats into the file (stats.tsv) counting number of unique sequences per transcript.

make.bd.sequences.py: This scripts takes the output from make.bd.data.py (data.bd.tsv) and prepares the sequences for a2z embedding extraction in the file (bd.sequences.a2z.tsv), and for caduceus embedding extraction in the file (bd.sequences.caduceus.tsv). 

make.bd.embedding.a2z.py: This script takes the prepared sequences in the file (bd.sequences.a2z.tsv), extracts a2z embeddings which are output into (embeddings.bd.a2z.h5).

make.bd.embedding.caduceus.py: This script takes the prepared sequences in the file (bd.sequences.cadeuceus.tsv), extracts a2z embeddings which are output into (embeddings.bd.cadeuceus.h5).

generate_predictions_hd5.py: This script reads embeddings generated by (make.bd.embedding.caduceus.py) and generates predictions for them using our own trained models. It needs the following files: (data.csv) which is the training data for PlantCaduceus. (gene.id.translation.ts) which translates between IDs and lines for plants with RNAseq data. (embeddings.bd.caduceus.h5) which contains the caduceus derived and (embeddings.bd.a2z.h5) which contains the a2z derived embeddings. Lastly it needs the folder with the models defined (datadir), which which it reads the models and (group_for_cross_validation.npy) the file containing information on the models. The script variable "EXTRA" needs to be set to either "none", "pred" or "emb" depending on the model variant to use for prediction. The script outputs the file (predictions_%EXTRA%.tsv) containing predictions with the following columns: (id) plant id, "gene" the gene id, "transcript" the transcript id, "hash(seq)" hash of the sequence used for prediction which can be used to see which predictions are for identical sequences, "test_group" the test group of the gene, "model_1_pred"/"model_2_pred"/etc. with the prediction from the top 5 models.

make.wp2.dataset.py: This script reads predictions made using Caduceus, a2z embeddings for the BD21.3 population, along with actual RNAseq reads and combines them into a master dataset (wp2.dataset_X.tsv) for analysis using R scripts. It needs the file (RNAseq.reads.tsv) which has TPM reads for BD21.3 lines, as generated by the RNAseq toolchain. A file (RNAseq.ids.tsv) translating IDs between RNAseq reads e.g. XXX and our population e.g CXX M0XXX. A file (predictions.tsv) containing the predictions based on Caduceus, a2z embeddings of BD21.3 population. The script also generates the file (peer.expression.csv) needed by the tool PEER to calculate PEER factors, along with the the files (peer.genes.csv, peer.samples.csv) with column and row ids. It outputs three datasets, one for each type of included a2z embeddings (none, pred and emb). The output file contains the same columns as the file made by (generate_predictions_hd5.py), with an additional column containing the RNAseq derived TPM value for the gene at each row.  

peer.sh: Thus script is used to generate PEER factors for RNAseq reads. It requires the file peer.expression.csv which is output from the script (make.wp2.dataset.py) and it generates folders for peer factors 1 to 15, which are used for the final analysis by (wp2.analysis.R). The requires the tool PEER to be present in the bin folder.

wp2.analysis.R: This script does the final analysis of the predicted versus measured TPM values for each gene in BD21.3

1. RNAseq processing sequence:

	(a) RNAseq.pipeline.sh

	(b) RNAseq.QC.py

	(c) RNAseq.R

3. Embedding processing for training:

	(a) prepare.sequences.py

	(b) sequence2embedding.a2z.py

	(c) sequence2embedding.caduceus.py

2. Embedding processing for prediction:

	(a) make.bd.data.py

	(b) make.bd.sequences.py

	(c) make.bd.embedding.a2z.py

	(d) make.bd.embedding.caduceus.py

	(e) generate_predictions_hd5.py

4. Analysis:
   
	(a) make.wp2.dataset.py

	(b) peer.sh

  	(c) wp2.analysis.R
